services:
  # Lightweight composite server - routes requests to backend servers
  composite:
    build:
      context: ../..
      dockerfile: src/composite/Dockerfile
    ports:
      - "8000:8000"
    volumes:
      - ./composite-config.yaml:/app/composite-config.yaml:ro
    environment:
      - COMPOSITE_CONFIG_PATH=/app/composite-config.yaml
      - HOST=0.0.0.0
      - PORT=8000
    depends_on:
      - browser
      - data-analysis
      - dify
      - docx
      - file-management
      - frontend-design
      - google-workspace
      - nano-banana
      - o3
      - pdf
      - pptx
      - preview
      - shell
      - slack
      - vectorstore
      - xlsx
    restart: unless-stopped
    networks:
      - mcp-network

  # Backend MCP servers
  browser:
    image: browser:latest
    build:
      context: ../..
      dockerfile: src/browser/Dockerfile
    environment:
      - TRANSPORT=sse
      - HOST=0.0.0.0
      - PORT=8001
      - HEADLESS=${HEADLESS:-true}
      - BROWSER_TIMEOUT=${BROWSER_TIMEOUT:-30000}
      - NAVIGATION_TIMEOUT=${NAVIGATION_TIMEOUT:-60000}
    networks:
      - mcp-network

  dify:
    image: dify:latest
    build:
      context: ../..
      dockerfile: src/dify/Dockerfile
    environment:
      - TRANSPORT=sse
      - HOST=0.0.0.0
      - PORT=8003
      - DIFY_API_KEY=${DIFY_API_KEY}
      - DIFY_BASE_URL=${DIFY_BASE_URL:-https://api.dify.ai/v1}
      - DIFY_CONSOLE_API_KEY=${DIFY_CONSOLE_API_KEY}
      - DIFY_CONSOLE_BASE_URL=${DIFY_CONSOLE_BASE_URL:-https://api.dify.ai}
    networks:
      - mcp-network

  pdf:
    image: pdf:latest
    build:
      context: ../..
      dockerfile: src/pdf/Dockerfile
    environment:
      - TRANSPORT=sse
      - HOST=0.0.0.0
      - PORT=8009
    networks:
      - mcp-network

  xlsx:
    image: xlsx:latest
    build:
      context: ../..
      dockerfile: src/xlsx/Dockerfile
    environment:
      - TRANSPORT=sse
      - HOST=0.0.0.0
      - PORT=8015
    networks:
      - mcp-network

  docx:
    image: docx:latest
    build:
      context: ../..
      dockerfile: src/docx/Dockerfile
    environment:
      - TRANSPORT=sse
      - HOST=0.0.0.0
      - PORT=8004
    networks:
      - mcp-network

  pptx:
    image: pptx:latest
    build:
      context: ../..
      dockerfile: src/pptx/Dockerfile
    environment:
      - TRANSPORT=sse
      - HOST=0.0.0.0
      - PORT=8010
    networks:
      - mcp-network

  preview:
    image: preview:latest
    build:
      context: ../..
      dockerfile: src/preview/Dockerfile
    environment:
      - TRANSPORT=sse
      - HOST=0.0.0.0
      - PORT=8011
      - HTTP_PORT=3000
      - HTTP_HOST=0.0.0.0
    networks:
      - mcp-network

  vectorstore:
    image: vectorstore:latest
    build:
      context: ../..
      dockerfile: src/vectorstore/Dockerfile
    environment:
      - TRANSPORT=sse
      - HOST=0.0.0.0
      - PORT=8014
      - OPENAI_API_KEY=${OPENAI_API_KEY}
    networks:
      - mcp-network

  data-analysis:
    image: data-analysis:latest
    build:
      context: ../..
      dockerfile: src/data-analysis/Dockerfile
    environment:
      - TRANSPORT=sse
      - HOST=0.0.0.0
      - PORT=8002
    networks:
      - mcp-network

  file-management:
    image: file-management:latest
    build:
      context: ../..
      dockerfile: src/file-management/Dockerfile
    environment:
      - TRANSPORT=sse
      - HOST=0.0.0.0
      - PORT=8005
    networks:
      - mcp-network

  frontend-design:
    image: frontend-design:latest
    build:
      context: ../..
      dockerfile: src/frontend-design/Dockerfile
    environment:
      - TRANSPORT=sse
      - HOST=0.0.0.0
      - PORT=8006
    networks:
      - mcp-network

  google-workspace:
    image: google-workspace:latest
    build:
      context: ../..
      dockerfile: src/google-workspace/Dockerfile
    environment:
      - TRANSPORT=sse
      - HOST=0.0.0.0
      - PORT=8016
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
    networks:
      - mcp-network

  nano-banana:
    image: nano-banana:latest
    build:
      context: ../..
      dockerfile: src/nano-banana/Dockerfile
    environment:
      - TRANSPORT=sse
      - HOST=0.0.0.0
      - PORT=8007
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
    networks:
      - mcp-network

  o3:
    image: o3:latest
    build:
      context: ../..
      dockerfile: src/o3/Dockerfile
    environment:
      - TRANSPORT=sse
      - HOST=0.0.0.0
      - PORT=8008
      - OPENAI_API_KEY=${OPENAI_API_KEY}
    networks:
      - mcp-network

  shell:
    image: shell:latest
    build:
      context: ../..
      dockerfile: src/shell/Dockerfile
    environment:
      - TRANSPORT=sse
      - HOST=0.0.0.0
      - PORT=8012
    networks:
      - mcp-network

  slack:
    image: slack:latest
    build:
      context: ../..
      dockerfile: src/slack/Dockerfile
    environment:
      - TRANSPORT=sse
      - HOST=0.0.0.0
      - PORT=8013
      - SLACK_BOT_TOKEN=${SLACK_BOT_TOKEN}
      - SLACK_USER_TOKEN=${SLACK_USER_TOKEN}
      - SLACK_SAFE_SEARCH=${SLACK_SAFE_SEARCH:-false}
    networks:
      - mcp-network

networks:
  mcp-network:
    driver: bridge
